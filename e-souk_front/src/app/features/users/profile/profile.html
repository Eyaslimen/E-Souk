<div class="profile-container">
  <!-- Header -->
  <div class="header">
    <h1 class="main-title">Mon Profil</h1>
    <p class="subtitle">
      Gérez vos informations personnelles, suivez vos commandes et découvrez vos boutiques préférées
    </p>
  </div>

  <!-- User Profile Card -->
  <div class="profile-header">
  <div class="profile-card" >
    <div class="profile-info" *ngIf="userInfo">
      <div class="avatar-container">
        <div class="avatar">
      <span class="avatar-text">{{ userInfo?.username?.substring(0, 1) || 'U' }}</span>
        </div>
        <button class="camera-btn">
          <i class="fas fa-camera"></i>
        </button>
      </div>
      <div class="user-details">
        <h2 class="user-name">{{ userInfo.username }}</h2>
        <p class="user-email">{{ userInfo.email }}</p>
        <div class="badges">
          <span class="badge badge-owner">
            <i class="fas fa-store"></i>
            Propriétaire de boutique
          </span>
        </div>
      </div>
    </div> 
    <div class="logout">
      <button (click)="logout()" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</button>
    </div>
  </div>
  <!-- <div class="shop-card">
    <h2 class="myshop_title">Eya's Shop</h2>
    <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat_values">
            <div class="stat-value">{{ shopStats.sales }}</div>
            <div class="stat-label">Ventes</div></div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat_values">
            <div class="stat-value">{{ shopStats.clients }}</div>
            <div class="stat-label">Clients</div></div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">
              <i class="fas fa-box"></i>
            </div>
            <div class="stat_values">
            <div class="stat-value">{{ shopStats.products }}</div>
            <div class="stat-label">Produits</div></div>
          </div>
        </div>
        <button class="btn gerer">Gérer</button>
      </div> -->
  </div>

  <!-- Shop Summary Card -->
  <!-- <div class="card shop-card">
    <div class="shop-content">
      <div class="shop-info">
        <div class="shop-header">
          <i class="fas fa-store-alt shop-icon"></i>
          <h3 class="shop-label">Ma Boutique</h3>
        </div>
        <h4 class="shop-name">Boutique Marie</h4>
        
      <button class="btn btn-primary" (click)="manageShop()">
        <i class="fas fa-cog"></i>
        Gérer ma boutique
      </button>
    </div>
  </div> -->

  <!-- Navigation Tabs -->
  <div class="tabs-container">
    <div class="tabs-list">
      <button 
        class="tab-trigger" 
        [class.active]="activeTab === 'personnel'"
        (click)="setActiveTab('personnel')">
        <i class="fas fa-user"></i>
        <span>Personnel</span>
      </button>
      <button 
        class="tab-trigger" 
        [class.active]="activeTab === 'boutiques'"
        (click)="setActiveTab('boutiques')">
        <i class="fas fa-store"></i>
        <span>Boutiques</span>
      </button>
      <button 
        class="tab-trigger" 
        [class.active]="activeTab === 'commandes'"
        (click)="setActiveTab('commandes')">
        <i class="fas fa-clipboard-list"></i>
        <span>Commandes</span>
      </button>
      <button 
        class="tab-trigger" 
        [class.active]="activeTab === 'panier'"
        (click)="setActiveTab('panier')">
        <i class="fas fa-shopping-cart"></i>
        <span>Panier</span>
      </button>
      <button 
        class="tab-trigger" 
        [class.active]="activeTab === 'favoris'"
        (click)="setActiveTab('favoris')">
        <i class="fas fa-heart"></i>
        <span>Favoris</span>
      </button>
    </div>

    <!-- Personal Information Tab -->
    <div class="tab-content" *ngIf="activeTab === 'personnel'">
      <div class="cards-grid" *ngIf="userInfo">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-user-edit"></i>
              Informations personnelles
            </h3>
            <button class="modifier btn btn-outline" (click)="toggleEdit()">
              <i class="fas" [class.fa-edit]="!isEditing" [class.fa-times]="isEditing"></i>
              {{ isEditing ? 'Annuler' : 'Modifier' }}
            </button>
          </div>
          <div class="card-content">
            <div class="form-group">
              <label for="name">
                <i class="fas fa-user"></i>
                Nom d'utilisateur
              </label>
              <input 
                id="name" 
                type="text" 
                [(ngModel)]="userInfo.username" 
                [disabled]="!isEditing"
                class="form-input">
            </div>
            <div class="form-group">
              <label for="email">
                <i class="fas fa-envelope"></i>
                Email
              </label>
              <input 
                id="email" 
                type="email" 
                [(ngModel)]="userInfo.email" 
                [disabled]="!isEditing"
                class="form-input">
            </div>
            <div class="form-group">
              <label for="phone">
                <i class="fas fa-phone"></i>
                Téléphone
              </label>
              <input 
                id="phone" 
                type="text" 
                [(ngModel)]="userInfo.phone" 
                [disabled]="!isEditing"
                class="form-input">
            </div>
            <div class="form-group">
              <label for="address">
                <i class="fas fa-map-marker-alt"></i>
               Address
              </label>
              <input 
                id="address" 
                type="text" 
                [(ngModel)]="userInfo.address" 
                [disabled]="!isEditing"
                class="form-input">
            </div>
            <button 
              *ngIf="isEditing" 
              class="btn btn-primary full-width" 
              (click)="saveProfile()">
              <i class="fas fa-save"></i>
              Sauvegarder les modifications
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-shield-alt"></i>
              Sécurité
            </h3>
          </div>
          <div class="card-content">
            <div class="form-group">
              <label for="currentPassword">
                <i class="fas fa-lock"></i>
                Mot de passe actuel
              </label>
              <input 
                id="currentPassword" 
                type="password" 
                [(ngModel)]="passwordData.currentPassword"
                class="form-input">
            </div>
            <div class="form-group">
              <label for="newPassword">
                <i class="fas fa-key"></i>
                Nouveau mot de passe
              </label>
              <input 
                id="newPassword" 
                type="password" 
                [(ngModel)]="passwordData.newPassword"
                class="form-input">
            </div>
            <div class="form-group">
              <label for="confirmPassword">
                <i class="fas fa-check-circle"></i>
                Confirmer le mot de passe
              </label>
              <input 
                id="confirmPassword" 
                type="password" 
                [(ngModel)]="passwordData.confirmPassword"
                class="form-input">
            </div>
            <button class="btn btn-secondary full-width" (click)="changePassword()">
              <i class="fas fa-sync-alt"></i>
              Changer le mot de passe
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Followed Shops Tab -->
    <div class="tab-content" *ngIf="activeTab === 'boutiques'">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-store"></i>
            Boutiques suivies ({{ followedShops.length }})
          </h3>
        </div>
        <div class="card-content">
          <div class="shops-list">
            <div class="shop-follow-card" *ngFor="let shop of followedShops; let i = index">
              <div class="shop-card-content">
                <div class="avatar-small">
                  <img [src]="'http://localhost:8080/uploads/' + shop.logoPicture"  alt="">
                </div>

                <div class="shop-card-info">
                  <h4 class="shop-card-name">{{ shop.brandName }}</h4>
                  <p class="shop-card-location">
                    <i class="fas fa-map-marker-alt"></i>
                    {{ shop.categoryName }}
                  </p>
                </div>
                <button class="btn-unfollow" (click)="unfollowShop(i)">
                  Unfollow
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Tab -->
    <div class="tab-content" *ngIf="activeTab === 'commandes'">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title" *ngIf="userOrders">
            <i class="fas fa-clipboard-list"></i>
            Commandes passées ({{ userOrders.totalOrders}} commandes - {{userOrders.shopCount}} boutique)
          </h3>
        </div>
           <div class="orders-container">

      <!-- Loading -->
      <div *ngIf="loading" class="loading">
        Chargement des commandes...
      </div>

      <!-- Orders Table -->
      <div *ngIf="!loading && userOrders" class="table-container">
        <table class="orders-table">
          <thead>
            <tr *ngIf="userOrders.totalOrders>0">
              <th>Boutique</th>
              <th>Produits</th>
              <th>Date</th>
              <th>Total</th>
              <th>État</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let shop of userOrders.shopOrders">
              <tr *ngFor="let order of shop.orders; let orderIndex = index" class="order-row">
                <!-- Boutique (affiché une seule fois par shop) -->
                <td class="boutique-cell">
                  <span *ngIf="orderIndex === 0" class="shop-name">
                    {{ shop.shopName }}
                  </span>
                </td>
                
                <!-- Produits -->
                <td class="products-cell">
                  <div class="product-item" *ngFor="let item of order.orderItems">
                    <img [src]="'http://localhost:8080/uploads/' + item.productImage" [alt]="item.productName" class="product-image">
                    <div class="product-info">
                      <div class="product-name">{{ item.productName }} ( {{item.price}} DT )</div>
                                <div class="product-variant">
                                  {{ item.variantNames?.join(' - ') }}
                                </div> 
                      <div class="product-quantity">Qté: {{ item.quantity }}</div>
                    </div>
                  </div>
                </td>
                
                <!-- Date -->
                <td class="date-cell">
                  {{ formatDate(order.createdAt) }}
                </td>
                
                <!-- Total -->
                <td class="total-cell">
                  {{ order.total }} DT
                </td>
                
                <!-- État -->
                <td class="status-cell">
                  <span [class]="getStatusClass(order.etat)">
                    {{ getStatusText(order.etat) }}
                  </span>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <!-- <div *ngIf="!loading && (!userOrders || userOrders.shopOrders.length === 0)" class="empty-state">
        <p>Aucune commande trouvée</p>
      </div> -->

      <!-- Error State -->
      <!-- <div *ngIf="error" class="error-state">
        <p>Erreur lors du chargement des commandes: {{ error }}</p>
      </div> -->
    </div>





    </div>
    </div>
    <div class="tab-content" *ngIf="activeTab === 'panier'">
      <div class="card">
<!-- <div class="cart-container"> -->
      <!-- Loading -->
      <div *ngIf="loading" class="loading">
        <div class="spinner"></div>
        <p>Chargement...</p>
      </div>

      <!-- Empty Cart -->
      <div *ngIf="!loading && (!cart || cart.shopCarts.length === 0)" class="empty">
        <div class="empty-icon">🛒</div>
        <h2>Panier vide</h2>
        <p>Ajoutez des produits pour commencer</p>
      </div>

      <!-- Cart Content -->
      <div *ngIf="!loading && cart && cart.shopCarts.length > 0">
        <!-- Header -->
        <!-- <div class="header">
          <div class="header-info">
            <h1>🛒 Mon Panier</h1>
            <div class="summary">
          <div class="summary-info">
            <p>💡 <strong>Info:</strong> Une commande séparée sera créée pour chaque boutique</p>
          </div>
        </div>
            <p>{{ cart.totalItems }} articles • {{ cart.shopCount }} boutiques</p>
          </div>
          <div class="header-total">
            <span class="total">{{ cart.totalPrice.toFixed(2) }} DT</span>
          </div>
        </div> -->
        <div class="card-header">
      <h3 class="card-title">
            <i class="fas fa-shopping-cart"></i>
           Mon Panier
          </h3> 
        </div>
          <div class="summary">
          <div class="summary-info">
            <p>💡 <strong>Info:</strong> Une commande séparée sera créée pour chaque boutique</p>
          </div>
        </div>
            
        <!-- Shops -->
        <div class="shops">
          <div *ngFor="let shop of cart.shopCarts" class="shop">
            <!-- Shop Header -->
            <div class="shop-header">
              <div class="shop-name-header">
                  <div class="avatar-small-shop">
                  <img [src]="'http://localhost:8080/uploads/' + shop.shopPicture"  alt="">
                </div> 
              <h2>{{ shop.shopName }}</h2></div>
              <span class="shop-total">{{ shop.shopTotal.toFixed(2) }} DT</span>
            </div>

            <!-- Products -->
            <div class="products">
              <div *ngFor="let item of shop.items" class="product">
                <div class="product-image">
                  <div class="avatar-small">
                  <img [src]="'http://localhost:8080/uploads/' + item.picture"  alt="">
                </div>
                </div>
                
                <div class="product-info">
                  <h3>{{ item.name }}</h3>
                  
                  <!-- Attributes -->
                  <div *ngIf="hasAttributes(item)" class="attributes">
                    <span *ngFor="let attr of getAttributes(item)" class="attribute">
                      {{ attr.key }}: {{ attr.value }}
                    </span>
                  </div>
                  
                  <div class="product-details">
                    <span class="price">{{ item.price.toFixed(2) }} DT</span>
                    <span class="quantity">Qté: {{ item.quantity }}</span>
                    <span class="total">{{ (item.price * item.quantity).toFixed(2) }} DT</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Order Button -->
            <div class="shop-footer">
              <button (click)="orderShop(shop)" class="order-btn">
                 Commander ({{ shop.shopTotal.toFixed(2) }} DT)
              </button>
            </div>
          </div>
        </div>

      </div>
    <!-- </div> -->
    </div>
  </div>

    <!-- Favorites Tab -->
    <div class="tab-content" *ngIf="activeTab === 'favoris'">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-heart"></i>
            Mes favoris ({{ productsFavoris.length }} produits)
          </h3>
        </div>
        <div class="card-content">
          <div class="favorites-grid">
            <div class="favorite-item" *ngFor="let item of productsFavoris">
              <div class="favorite-image-container">
                <img [src]="'http://localhost:8080/uploads/' + item.picture" [alt]="item.name" class="favorite-image">
                <div class="favorite-overlay">
                  <i class="fas fa-heart"></i>
                </div>
              </div>
              <div class="favorite-content">
                <h4 class="favorite-name">{{ item.name }}</h4>
                <p class="favorite-shop">
                  <i class="fas fa-store"></i>
                  {{ item.shopName }}
                </p>
                <div class="favorite-footer">
                  <span class="favorite-price">{{ item.price }}</span>
                  <button class="btn btn-primary small" (click)="addToCart(item)">
                    <i class="fas fa-cart-plus"></i>
                    Ajouter
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>